#!/bin/bash
#
# Helper to run tests on Travis CI service.
#
# Will exit after first error to reduce load on Travis servers.
# On errors, developers should run full tests on their computers.
#

COMMAND=$1

TRIAL_COMMAND="./bin/trial -x --reporter=text --unclean-warnings"

#
# Run trial on twisted.
#
run_trial() {
    pip install .
    pip install -r requirements.txt
    find . -name "*.pyc" -or -name "*$py.class" | xargs rm -f
    python $TRIAL_COMMAND $@ twisted
    return $?
}

COMMANDS='
    py-without-modules
    py-select-gc
    py-pool
    py-epool
    py-glib2
    py-3.3
    pyflakes
    documentation
    api-reference
    '


case "$COMMAND" in
    "py-without-modules")
        run_trial --without-module OpenSSL --without-module Crypto
        ;;

    "py-select-gc")
        run_trial --force-gc --reactor=select
        ;;

    "py-pool")
        run_trial --reactor=poll
        ;;

    "py-epool")
        run_trial --reactor=epoll
        ;;

    "py-glib2")
        # Install glib and run python from the system.
        echo "Updating packages..."
        #sudo apt-get update -qq
        echo "Installing documentation..."
        sudo apt-get install -qq python-gobject python-pip
        echo "Running tests..."
        /usr/bin/python $TRIAL_COMMAND --reactor=glib2 twisted
        ;;

    "py-3.3")
        find . -name "*.pyc" -or -name "*$py.class" | xargs rm -f
        # Buffer stdout/stderr, allow Ctrl+C to stop the tests
        # and exit on first error.
        pip install .
        pip install -r requirements.txt
        python3.3 admin/run-python3-tests -b -c -f
        ;;

    "pyflakes")
        pip install pyflakes==0.7.3
        pyflakes twisted
        ;;

    "documentation")
        echo "Building docs"
        pip install sphinx==1.2.1
        python ./bin/admin/build-docs . doc/core/howto/template.
        ;;

    "api-reference")
        echo "Building apidocs"
        pip install pydoctor==0.5
        python ./bin/admin/build-apidocs . apidocs
        ;;

    *)
        echo "Unknown command $COMMAND"
        echo "Available commands: $COMMANDS"
        exit 1
esac

exit $?
