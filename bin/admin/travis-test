#!/bin/bash
#
# Helper to run tests on Travis CI service.
#
# Will exit after first error to reduce load on Travis servers.
# On errors, developers should run full tests on their computers.
#

COMMAND=$1

# Run miniam report to reduce log size and exit of fist error.
TRIAL_COMMAND="./bin/trial --reporter=text --unclean-warnings"
# Allow Ctrl+C to stop the tests and exit on first error.
# When Buffer stdout/stderr, test runner is crashing.
PYTHON_3_TEST="./admin/run-python3-tests -c"

#
# Install project and dependencies with pip.
#
pip_install() {
    pip install .
    pip install -r requirements.txt
    # Removed compiled python files.
    find . -name "*.pyc" -or -name "*$py.class" | xargs rm -f
}

#
# Produce trial log.
#
trial_log() {
    echo ""
    echo "--------------------------------------------------------"
    echo "Trial log"
    echo "--------------------------------------------------------"
    cat _trial_temp/test.log
}


#
# Run trial on twisted.
#
run_trial() {
    pip_install
    python $TRIAL_COMMAND $@ twisted
    exit_code=$1
    trial_log
    return $exit_code
}

COMMANDS='
    py-without-modules
    py-select-gc
    py-select
    py-pool
    py-epool
    py-glib2
    py-3.3
    pyflakes
    documentation
    api-reference
    '


case "$COMMAND" in
    "py-without-modules")
        run_trial --without-module OpenSSL --without-module Crypto
        ;;

    "py-select-gc")
        run_trial --force-gc --reactor=select
        ;;

    "py-select")
        run_trial --reactor=select
        ;;

    "py-pool")
        run_trial --reactor=poll
        ;;

    "py-epool")
        run_trial --reactor=epoll
        ;;

    "py-glib2")
        # Install glib and run python from the system.
        echo "Updating packages..."
        #sudo apt-get update -qq
        echo "Installing documentation..."
        sudo apt-get install -qq python-gobject python-pip
        echo "Running tests..."
        /usr/bin/python $TRIAL_COMMAND --reactor=glib2 twisted
        ;;

    "py-3.3")
        pip_install
        python3.3 $PYTHON_3_TEST
        exit_code=$?
        trial_log
        exit $exit_code
        ;;

    "pyflakes")
        pip install pyflakes==0.7.3
        pyflakes twisted
        ;;

    "documentation")
        echo "Building docs"
        pip install . sphinx==1.2.1
        python ./bin/admin/build-docs . doc/core/howto/template.
        ;;

    "api-reference")
        echo "Building apidocs"
        pip install pydoctor==0.5
        python ./bin/admin/build-apidocs . apidocs
        ;;

    *)
        echo "Unknown command $COMMAND"
        echo "Available commands: $COMMANDS"
        exit 1
esac

exit $?
